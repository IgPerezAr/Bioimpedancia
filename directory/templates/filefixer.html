{% extends 'base.html' %}
{% load static %}

{% block cspage %}
    {% comment %} <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" crossorigin="anonymous"> {% endcomment %}
    <link href="{% static 'bootstrap-fileinput/css/fileinput.css' %}" media="all" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" crossorigin="anonymous">
    {% comment %} <link href="{% static 'bootstrap-fileinput/themes/explorer-fas/theme.css' %}" media="all" rel="stylesheet" type="text/css"/> {% endcomment %}
{% endblock cspage %}

{% block content %}

    {% include 'navbar.html' %}

    <div class="site-blocks-cover overlay" data-aos="fade">

      <div class="container">
        <div class="row align-items-center justify-content-center">

          <div id="centerPage" class="col-md-10 mt-lg-5 text-center">
                <h1 data-aos="fade-up">Reparar ARCHIVO</h1>
                
                <p class="mb-5 desc"  data-aos="fade-up" data-aos-delay="100">
                    Reparar <b>CSV</b> definiendo el o los formatos de descarga.
                    <br>Repara tu archivo online.</p>

                <div data-aos="fade-up" data-aos-delay="100">
                    <form method="POST" enctype="multipart/form-data">
                        <input id="data_file" name="data_file[]" type="file" accept=".csv" multiple="multiple">
                    </form>
                </div>
          </div>
            
        </div>
      </div>

    </div>



    {% include 'footer.html' %}
{% endblock content %}

{% block jspage %}
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="{% static 'bootstrap-fileinput/js/plugins/piexif.js' %}" type="text/javascript"></script>
    <script src="{% static 'bootstrap-fileinput/js/plugins/sortable.js' %}" type="text/javascript"></script>
    <script src="{% static 'bootstrap-fileinput/js/fileinput.js' %}" type="text/javascript"></script>
    <script src="{% static 'bootstrap-fileinput/js/locales/es.js' %}" type="text/javascript"></script>
    <script src="{% static 'bootstrap-fileinput/themes/fas/theme.js' %}" type="text/javascript"></script>
    <script src="{% static 'bootstrap-fileinput/themes/explorer-fas/theme.js' %}" type="text/javascript"></script>


    <script type="text/javascript">
        $(document).ready(function () {
            var url_mask = "{% url 'filefixer' %}"
            var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();

            $("#data_file").fileinput({
                language: 'es',
                
                showUpload: true,
                showCaption: false,
                showClose: false,
                showRemove: false,
                browseClass: "btn btn-primary btn-md",
                fileActionSettings: {
                    showUpload: false,
                },

                allowedFileExtensions: ['csv'],
                uploadUrl: url_mask,
                uploadAsync: false,
                uploadExtraData: {
                    uploadToken: '{{ csrf_token }}'
                },
                maxFileCount: 10,
                maxFileSize: 1000,
                theme: 'fas',
                preferIconicPreview: true,
                previewFileIconSettings: {
                    'csv': '<i class="fas fa-file-csv text-success"></i>',    
                },
                previewFileExtSettings: { 
                    'csv': function(ext) {
                        return ext.match(/(csv)$/i);
                    },
                }
            }) 
        }).on('filebatchuploadsuccess', function(event, data) {
            var link = document.createElement("a");
            var text = document.createElement("span");

            text.textContent = "Descargar";
            
            link.appendChild(text);
            link.setAttribute("id", "zipDownload");
            link.setAttribute("href", "/media/" + data.response.urlDownload);
            link.setAttribute("download", "Bioimpedancia - Archivos reparados");
            link.setAttribute("class", "mt-4 btn btn-default btn-lg btn-primary");
            link.setAttribute("style", "width:273pt;");

            document.getElementById("centerPage").appendChild(link);

            console.log(data.response.graphData);

        }).on('filebatchuploadcomplete', function(event, data) {
            $("#data_file").fileinput('disable');
            var uploadBtn = document.getElementsByClassName('fileinput-upload-button');
            var browseBtn = document.getElementsByClassName('btn-file');

            uploadBtn[0].hidden = true;
            browseBtn[0].hidden = true;
        });
    </script>

{% endblock jspage %}


